\chapter{State of the Art: Frameworks to Control Aerial Robot Swarms}

For the following discussion it is assumed that the drone has an companion computer.
The aim is to test a computationally demanding low-level control algorithm directly controlling the speed of the motor of the drone. This is today impossible on most of the available flight controllers.

\section{Autopilot software}

\subsection{ROSflight \& ROScopter}
The core strength of ROSflight is that it has been designed to control a drone with a companion computer, and it has an easy-to-understand code base that is kept lean.
It is easy to build on top of ROSflight to add functionalities. The project ROScopter \cite{github_roscopter} for example add the support of waypoint position control.

There is only a few flight controller that are know to be compatible with ROSflight (e.g. OpenPilot Revolution and PixHawk).
So, if another flight controller is chosen, some more configurations would have to be done.

ROS is a core functionality of ROSflight.

ROSflight have a \gls{sitl} simulator.

It should be possible to directly control the speed of the motors \cite{github_rosflight_98}.

\subsection{ArduPilot}
ArduPilot and more precisely ArduCopter has a lot of features.
It has numerous flight modes.
\Gls{ekf} is computed on the flight controller.
It has its own Ground Control Station to flash its firmware and modify settings.
ArduPilot is compatible with a lot of flight controller
It has a strong community.
It has a really good documentation.
It is tested a lot and the users report problem when they arise.

ArduPilot be used  with ROS.

ArduPilot also have a \gls{sitl} simulator.

It is possible to directly control the speed of the motors \cite{github_ardupilot_11859}.

\subsection{PX4}
PX4 has a lot of features.
It has numerous flight modes.
\Gls{ekf} is computed on the flight controller.
It has its own Ground Control Station to flash firmware and modify the settings.
It has a strong community.
It has a good documentation.
It is tested a lot and the users report problem when they arise.

PX4 be used  with ROS.

PX4 also have a SITL simulator.

It should be possible to directly control the speed of the motors \cite{px4_low_level_control}.

\section{A comparison between the different Frameworks}
Every frameworks has a simulator to test the control algorithm.
mavlink to communicate between the companion board and the flight controller, failsafe

PX4 and ArduPilot are extremely similar.

These blog posts provide a comparison of open source drone software frameworks \cite{drone_software_projects} and many flight controllers \cite{drone_flight_controllers}.

\subsection{Communication}
The communication between the companion computer and the flight controller of the drones are done with the MAVlink protocol. All firmware use MAVlink but each firmware has its own implementation. ArduPilot and PX4 use MAVROS and ROSflight use rosflight\_io

\subsection{Network}
There is one ground control station and the companion computer of the drones are connected to it via wifi.

\subsection{ROS}
About ROS, there is only one roscore needed on a network \cite{stackoverflow_multi_machine}.
So, the ground control station run roscore and stream vicon data to the drones. It would also create log file.
The companion computer on the drones would run either \texttt{MAVROS} or \texttt{rosflight\_io}.
It would also run the control algorithm.
{\color{red} \\Please also discuss the current and coming capability for ROS2 which would be ideal for real-time and multi-robot system. PX4 is surely the most advanced in this, see project status roadmap ref project status \cite{px4}, also ref \cite{ros_wiki_ng_drones}. The advantages that ROS2 brings are of a great asset for computation and communication for the need of this project.\\}

There is also ROS2, it is a new version of ROS that can be use without a master, it supports real-time and it has retro-compatibility with ROS1. But, it is still under heavy development, for now it is not advise to use ROS2.

\subsection{Vicon}
\cite{ros_wiki_vicon_bridge}
\cite{px4_vicon}
\cite{ardupilot_vicon}

\subsection{Extended Kalman Filter}
ArduPilot and PX4 have the \gls{ekf} on the flight controller.
The MAVLINK message \texttt{ATT\_POS\_MOCAP} has been to created to give the data of Vicon to the \gls{ekf}.

ROSflight has just a complementary filter on the flight controller (a simpler algorithm).
But, it is possible to run an \gls{ekf} on the companion computer with ROScopter but it would have to be modify to add vicon support.

Running the \gls{ekf} on the flight controller means that vicon data has to be sent to the flight controller and then the \gls{ekf} estimation has to be sent back to the companion computer.

Running the \gls{ekf} run on the companion computer means that the flight controller has to sent the sensor data to the companion computer and optionally sent back the \gls{ekf} estimation to the flight controller if we want to use the flight controller as controller.

For the second solution, the EKF needs to be implemented and tuned.
The first solution is easier to set up and would be ideal if we want to compare the performance of our own control algorithm to the PX4 and ArduPilot numerous flight mode but ROSflight would not have a position estimate from Vicon.

\subsection{Sending PWM command}
ROSflight is the most advanced, in the implementation.
{\color{red}Explain how the solution of raspberry pie and the emlid navio2 deck. Would there be less latency and bandwidth problems if evrything is running on the rasppie 3/4? Just having all computation in 1 unit seems very interesting to me.}

\subsection{Swarm compatibility}
Both ArduPilot \cite{ardupilot_multi_vehicle} and PX4 \cite{px4_multi_vehicle}
have proof of concept that swarm of drone are possible.

It should be possible for ROSflight \cite{github_rosflight_100} too.
But, some firmware modification has to be done.

\subsection{Simulator}
All firmware have SIL/SITL simulator.
Only PX4 can simulate multiple drone out of the box {\color{red}and even in ROS2!}. It is advise here \cite{px4_ros2} to ROS1 as a first implementation and only use ROS2 if there is really a need.

\subsection{Serial bus}
Both Jetson Nano and Raspberry Pi have a hadware serial port.\\
ROSflight \cite{rosflight_parameters},
ArduPilot \cite{ardupilot_serial_parameters},
PX4 \cite{px4_serial_parameters},
can all configure their baud rate at least up to 115200. That is a baudrate that
Jetson Nano \cite{jetsonhacks_serial}
and
Raspberry Pi support \cite{rpi_stackexchange_serial}.
Higher baud rate can be tested when the flight controller has arrived.



\subsection{Flight controller}
\subsubsection{OpenPilot Revolution}
It is compatible with ROSflight and ArduPilot. It is a popular flight controller.
It comes with all the connectors needed \cite{bangood_revo}.


\subsubsection{PixHawk 2.4.8/PixRacer}
The PixHawk is compatible with every firmware.
It is the flight controller use by everyone, there is a lot of documentation, project. And ArduPilot recommend using it \cite{ardupilot_choose_fc}.
A small version of it is the PixRacer that is more abordable and adapted for this project \cite{mrobotics_pixracer}.

\subsubsection{Navio2+Raspberry Pi 4}
As the Raspberry Pi 4 has just been released it has different problems that has not been solved such as overheating, firmware problemsâ€¦ It is not software compatible with the NAVIO2 at the moment, they will release an new image when they will have done some test. It is adviced to wait until it had a bit of time on the market. So for now the raspberry pi 4 is not reliable enough for this project \cite{ardupilot_rpi_compatibility}.

If we use the Raspberry Pi 3B+ with Navio2, the frequency update is limited to 400Hz \cite{emlid_pwm_frequency}.

Here is a blog post about Navio2 + Raspberry Pie \cite{dojofordrones_rpi_drone}.

It is not recommended to directly control pwm and at the same time running ArduPilot \cite{emlid_servo_control}. It is recommended to control pwm via ArduPilot. It has to communicate via MAVLINK like the other flight controllers.

\subsection{On-board Computer}
\subsubsection{Nvidia Jetson Nano}
This computer is quite recent and it has only the latest version of Ubuntu that is Ubuntu 18.04.
But Ubuntu 16.04 is the version that is the most used at the moment in the drone world.
There not much support for it at the moment.

It is also bigger and heavier than it counterpart the Raspberry Pi. It is mainly due to its better performance, better graphic card and processor.

\subsubsection{Raspberry Pi}
The Raspberry Pi is one of the most companion computer use. It is lighter and smaller than the Jetson Nano.

A lot of project have been done with it.

There is a shield produce by the emlid company called Navio2. That add the functionality of flight controller to it.

\section{Conclusion}
ROSflight is a lightweight solution. The bare minimum is implemented, everything else has to be implemented and ROScopter add some functionality. But, it cannot compare to the full-fledged ArduPilot and PX4 \cite{reddit_firmware_ros}. Moreover, when somebody asked on forum if they should use ROSflight, it was recommended to use either ArduPilot or PX4 \cite{reddit_swarm_ros}.

In term of hardware, RaspberryPi4 + Navio2 is the easiest solution to directly control PWM outputs

    {\color{red}For me this conclusion is partially correct. I feel like the raspberry pie + navio idea is missing. }
    {\color{red}I feel more that ArduPilot and PX4 are so advanced that it would take somuch time to get even just some of the functionality in ROSflight. also the fact that e.g. with ArduPilot there are many types of systems we can use it very interesting for multi-robot. So I would put focus on ArduPilot/PX4 since they are very similar. But then the solution of a small rasppie 3 (and later 4) with navio 2 deck would be very relevant. also to add other motors for uav with arm for example we can use pins of rasppie. And rasppie is used by so many people.}
